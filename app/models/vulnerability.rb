class Vulnerability
  include Mongoid::Document
  include Mongoid::Timestamps::Created
  embeds_many :ratings
 
  field :slug, type: String, unique: true
  field :title, type: String
  field :content, type: String
  field :rating, type: Integer, default: 0
  key :slug
  
  attr_accessible :title, :content, :rating
  before_validation :set_slug
  before_save :set_title
  
  validates_length_of :content, minimum: 5, maximum: 5000

  def set_title
   self.title = 'untitled' if self.title.empty?
  end
  
  def set_slug
    if self.slug.nil?
      self.slug = rand(36**8).to_s(36) 
      self.set_slug if Vulnerability.exists?(conditions: {slug: self.slug})
    end
  end
end
